<!DOCTYPE html>
<html>
<head>
  <title>Weather Forecast</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .legend {
      font-size: 13px;
      font-weight: 500;
      color: #f9f5f5;
      margin-top: 10px;
    }
    .legend span {
      background: #094d81;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .table-container {
      max-height: 80vh;
      overflow-y: auto;
      margin-top: 10px;
    }

    /* Custom dropdown */

.site-selector {
  position: relative;
  display: inline-block;
  margin-right: 12px;
}
#siteButton {
  background: #006e8c;
  color: white;
  font-weight: 600;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
}
.site-list {
  position: absolute;
  top: 110%;
  left: 0;
  width: 240px;
  background-color: #303030;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 999;
  padding: 10px;
  max-height: 250px;
  overflow-y: auto;
}
.site-list label {
  display: flex;
  align-items: center;
  font-size: 14px;
  margin: 5px 0;
  color: #f9f5f5;
  cursor: pointer;
}
.site-list input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
}
.site-list.hidden {
  display: none;
}
  </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

<body>
  <h2>14-Days Weather Forecast</h2>


<div class="top-bar">
  <div class="left-buttons">
    <label>Select Site(s):</label>
    <div class="site-selector">
      <button id="siteButton">Select Sites </button>
      <div id="siteList" class="site-list hidden">
        <label><button id="clearFilterBtn" type="button">Clear Filter</button></label>
        <label><input type="checkbox" id="selectAll"/> All Sites</label>
        <div class="options"></div>
      </div>
    </div>
    <button onclick="getBothWeathers()">Get Weather</button>
  </div>

  <div class="download-buttons">
    <button class="download-buttons" onclick="downloadStyledExcel()">Download Report</button>

  </div>

  <div class="legend">
    <span><strong>R</strong> = Radiation (kWh/mÂ²), <strong>P</strong> = Precipitation (mm)</span>
  </div>
</div>



  <div id="combinedOutput" class="table-container"></div>

  <script>
    const sites = [
      { name: "Khambhat", lat: 22.32, lon: 72.44 },
      { name: "Khilchipur", lat: 24.07, lon: 76.59 },
      { name: "Odisha", lat: 20.55, lon: 83.37 },
      { name: "Chhattisgarh", lat: 21.12, lon: 82.48 },
      { name: "Jhunir", lat: 29.81, lon: 75.37 },
      { name: "Nangla", lat: 29.86, lon: 75.20 },
      { name: "Pattikonda", lat: 15.36, lon: 77.49 },
      { name: "Hindupur", lat: 13.98, lon: 77.48 },
      { name: "Rayachotti", lat: 14.11, lon: 78.79 },
      { name: "Santipuram", lat: 12.87, lon: 78.38 },
      { name: "Yemmiganur", lat: 15.67, lon: 77.48 },
      { name: "Maddur", lat: 16.89, lon: 77.58 },
      { name: "Balanagar", lat: 16.94, lon: 78.13 },
      { name: "Banka (Nalanda)", lat: 24.8102, lon: 86.8601 },
      { name: "Banka (Magadh)", lat: 24.8101, lon: 86.8602 },
      { name: "Mahoba", lat: 25.32, lon: 79.81 },
      { name: "Sadashivpet", lat: 17.70, lon: 77.81 },
      { name: "Padmajiwadi", lat: 18.41, lon: 78.21 },
      { name: "Mothkur", lat: 17.44, lon: 79.28 },
      { name: "Godhur-2", lat: 18.80, lon: 78.63 },
      { name: "Manthani-2", lat: 18.69, lon: 79.63 },
      { name: "Kosgi", lat: 16.97, lon: 77.65 },
      { name: "Bohngir", lat: 17.72, lon: 78.98 },
      { name: "Bhadla-L2", lat: 27.46, lon: 71.97 },
      { name: "Bhadla-L3", lat: 27.48, lon: 71.99 },
      { name: "Sidlaghatta", lat: 13.48, lon: 77.90 },
      { name: "MSEDCL-2", lat: 27.50, lon: 72.47 },
      { name: "Aklera", lat: 26.47, lon: 71.5401 },
      { name: "Deogarh", lat: 26.910, lon: 71.560 },
      { name: "Phalodi", lat: 26.90, lon: 71.55 },
      { name: "Raisar", lat: 26.94, lon: 71.54 },
      { name: "Dhaulpur", lat: 26.911, lon: 71.561 },
      { name: "Sikar", lat: 28.14, lon: 72.99 }
    ];

    // Build checkbox list
// const siteListDiv = document.querySelector('.options');
// sites.forEach(site => {
//   const val = `${site.lat},${site.lon}`;
//   const label = document.createElement('label');
//   label.innerHTML = `<input type="checkbox" value="${val}"/> ${site.name}`;
//   siteListDiv.appendChild(label);
// });

// Build checkbox list with name|lat|lon format
const siteListDiv = document.querySelector('.options');
sites.forEach(site => {
  const val = `${site.name}|${site.lat}|${site.lon}`;
  const label = document.createElement('label');
  label.innerHTML = `<input type="checkbox" value="${val}"/> ${site.name}`;
  siteListDiv.appendChild(label);
});


// Toggle dropdown open/close
const dropdown = document.getElementById("siteList");
const button = document.getElementById("siteButton");

button.onclick = (e) => {
  e.stopPropagation();
  dropdown.classList.toggle("hidden");
};

// Close dropdown when clicking outside
document.addEventListener("click", function (e) {
  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

// Prevent dropdown from closing when clicking inside
dropdown.addEventListener("click", function (e) {
  e.stopPropagation();
});

// Select All checkbox
document.getElementById('selectAll').onclick = function () {
  const checkboxes = document.querySelectorAll('.site-list input[type="checkbox"]:not(#selectAll)');
  checkboxes.forEach(cb => cb.checked = this.checked);
};

// Clear Filter button logic
document.getElementById('clearFilterBtn').onclick = function () {
  const checkboxes = document.querySelectorAll('.site-list input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
};

    // function getSelectedSites() {
    //   const checked = Array.from(document.querySelectorAll('.site-list input[type="checkbox"]:checked:not(#selectAll)'));
    //   return checked.map(cb => {
    //     const [lat, lon] = cb.value.split(',');
    //     return sites.find(site => site.lat == lat && site.lon == lon);
    //   });
    // }

    function getSelectedSites() {
  const checked = Array.from(document.querySelectorAll('.site-list input[type="checkbox"]:checked:not(#selectAll)'));
  return checked.map(cb => {
    const [name, lat, lon] = cb.value.split('|');
    return { name, lat, lon };
  });
}


    const weatherCodes = {
      0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
      45: "Fog", 48: "Rime fog", 51: "Light drizzle", 53: "Moderate drizzle", 55: "Dense drizzle",
      56: "Light freezing drizzle", 57: "Dense freezing drizzle", 61: "Slight rain", 63: "Moderate rain",
      65: "Heavy rain", 66: "Light freezing rain", 67: "Heavy freezing rain", 71: "Slight snow",
      73: "Moderate snow", 75: "Heavy snow", 77: "Snow grains", 80: "Slight rain showers",
      81: "Moderate rain showers", 82: "Violent rain showers", 85: "Slight snow showers",
      86: "Heavy snow showers", 95: "Thunderstorm", 96: "Thunderstorm with slight hail",
      99: "Thunderstorm with heavy hail"
    };

    function getWeatherClass(text) {
      const lower = text.toLowerCase();
      if (lower.includes("sunny") || lower.includes("clear")) return "sunny";
      if (lower.includes("cloud")) return "cloudy";
      if (lower.includes("overcast")) return "overcast";
      if (lower.includes("rain") || lower.includes("shower")) return "rainy";
      if (lower.includes("drizzle")) return "drizzly";
      if (lower.includes("fog") || lower.includes("mist") || lower.includes("haze")) return "foggy";
      if (lower.includes("snow") || lower.includes("sleet")) return "snowy";
      if (lower.includes("thunder")) return "stormy";
      if (lower.includes("freez") || lower.includes("ice")) return "freezing";
      return "unknown";
    }

    function getGHIClass(ghi) {
      if (ghi < 2) return "ghi-low";
      if (ghi < 4) return "ghi-medium";
      return "ghi-high";
    }

    function getPrecipClass(precip) {
      if (precip === 0) return "precip-low";
      if (precip < 5) return "precip-medium";
      return "precip-high";
    }

    // async function getBothWeathers() {
    //   const selectedSites = getSelectedSites();
    //   document.getElementById("combinedOutput").innerHTML = "";
    //   let isFirst = true;
    //   for (let site of selectedSites) {
    //     await getOpenMeteoWeather(site.lat, site.lon, site.name, isFirst);
    //     isFirst = false;
    //   }
    // }

async function getBothWeathers() {
  const selectedSites = getSelectedSites();
  document.getElementById("combinedOutput").innerHTML = "";

  if (selectedSites.length === 0) return;

  // Step 1: Fetch the first site separately to get header
  const firstSite = selectedSites[0];
  let { header, body } = await getOpenMeteoWeather(firstSite.lat, firstSite.lon, firstSite.name, true);

  // Step 2: Fetch the remaining sites in parallel
  const restSites = selectedSites.slice(1);
  const restPromises = restSites.map(site =>
    getOpenMeteoWeather(site.lat, site.lon, site.name, false)
  );

  const restResults = await Promise.all(restPromises);

  // Step 3: Combine all rows
  let allBody = body + restResults.map(r => r.body).join("");

  // Step 4: Render final table
  document.getElementById("combinedOutput").innerHTML = `<table><thead>${header}</thead><tbody>${allBody}</tbody></table>`;
}




    // async function getOpenMeteoWeather(lat, lon, siteName, isHeaderRequired = false) {
    //   const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,precipitation_sum,shortwave_radiation_sum&timezone=auto&forecast_days=14`;
    //   try {
    //     const res = await fetch(url);
    //     const data = await res.json();

    //     let row = `<tr><th class="site-column" style="text-align:center;">${siteName}</th>`;
    //     data.daily.time.forEach((date, i) => {
    //       const cond = weatherCodes[data.daily.weathercode[i]] || "Unknown";
    //       const ghi = +(data.daily.shortwave_radiation_sum[i] * 0.277778).toFixed(1);
    //       const precip = +data.daily.precipitation_sum[i].toFixed(1);
    //       row += `<td class="${getWeatherClass(cond)}">
    //         <div>${cond}</div>
    //         <div class="${getGHIClass(ghi)}">R - ${ghi}</div>
    //         <div class="${getPrecipClass(precip)}">P - ${precip}</div>
    //       </td>`;
    //     });
    //     row += `</tr>`;

    //     if (isHeaderRequired) {
    //       let header = `<tr><th class="site-header">Sites</th>`;
    //       data.daily.time.forEach(date => {
    //         const [yyyy, mm, dd] = date.split("-");
    //         header += `<th class="date-header">${dd}-${mm}</th>`;
    //       });
    //       header += `</tr>`;
    //       document.getElementById("combinedOutput").innerHTML += `<table><thead>${header}</thead><tbody>${row}</tbody></table>`;
    //     } else {
    //       document.querySelector("#combinedOutput table tbody").innerHTML += row;
    //     }
    //   } catch {
    //     document.getElementById("combinedOutput").innerHTML += `<p style="color:red;">Error fetching weather for ${siteName}</p>`;
    //   }
    // }

    async function getOpenMeteoWeather(lat, lon, siteName, isHeaderRequired = false) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,precipitation_sum,shortwave_radiation_sum&timezone=auto&forecast_days=14`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    let row = `<tr><th class="site-column" style="text-align:center;">${siteName}</th>`;
    data.daily.time.forEach((date, i) => {
      const cond = weatherCodes[data.daily.weathercode[i]] || "Unknown";
      const ghi = +(data.daily.shortwave_radiation_sum[i] * 0.277778).toFixed(1);
      const precip = +data.daily.precipitation_sum[i].toFixed(1);
      row += `<td class="${getWeatherClass(cond)}">
        <div>${cond}</div>
        <div class="${getGHIClass(ghi)}">R - ${ghi}</div>
        <div class="${getPrecipClass(precip)}">P - ${precip}</div>
      </td>`;
    });
    row += `</tr>`;

    let header = "";
    if (isHeaderRequired) {
      header = `<tr><th class="site-header">Sites</th>`;
      data.daily.time.forEach(date => {
        const [yyyy, mm, dd] = date.split("-");
        header += `<th class="date-header">${dd}-${mm}</th>`;
      });
      header += `</tr>`;
    }

    return { header, body: row };
  } catch (err) {
    return {
      error: `<p style="color:red;">Error fetching weather for ${siteName}</p>`
    };
  }
}


  // async function downloadExcel() {
  //   const table = document.querySelector("#combinedOutput table");
  //   if (!table) {
  //     alert("No data available to export.");
  //     return;
  //   }

  //   const workbook = XLSX.utils.book_new();
  //   const ws_data = [];
    
  //   // Extract table headers
  //   const headerCells = table.querySelectorAll("thead th");
  //   const headers = Array.from(headerCells).map(th => th.innerText.trim());
  //   ws_data.push(headers);

  //   // Extract table rows
  //   const rows = table.querySelectorAll("tbody tr");
  //   rows.forEach(row => {
  //     const rowData = [];
  //     row.querySelectorAll("td, th").forEach(cell => {
  //       rowData.push(cell.innerText.trim());
  //     });
  //     ws_data.push(rowData);
  //   });

  //   // Create worksheet
  //   const ws = XLSX.utils.aoa_to_sheet(ws_data);

  //   // Apply formatting: Freeze top row and style cells (through SheetJS hacks)
  //   ws['!freeze'] = { xSplit: 1, ySplit: 1 }; // Freeze top row and left column
  //   ws['!cols'] = headers.map(() => ({ wch: 20 })); // Set column width

  //   XLSX.utils.book_append_sheet(workbook, ws, "Weather Report");
  //   XLSX.writeFile(workbook, "Weather_Forecast.xlsx");
  // }

async function downloadStyledExcel() {
  const table = document.querySelector("#combinedOutput table");
  if (!table) return alert("No table found.");

  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("Weather Report");

  const rows = table.querySelectorAll("tr");
  rows.forEach((tr, rowIndex) => {
    const row = [];
    const cells = tr.querySelectorAll("th, td");
    cells.forEach((cell) => row.push(cell.innerText));
    worksheet.addRow(row);

    // Apply style row-wise
    cells.forEach((cell, colIndex) => {
      const excelCell = worksheet.getRow(rowIndex + 1).getCell(colIndex + 1);
      excelCell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };

      // Header styling
      if (tr.parentElement.tagName === "THEAD") {
        excelCell.font = { bold: true };
        excelCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'BDD7EE' }
        };
      } else {
        // Weather class-based fill
        const classList = cell.classList;

if (classList.contains("sunny")) {
  excelCell.fill = fill("#FFF4D3");  // light yellow
} else if (classList.contains("cloudy")) {
  excelCell.fill = fill("#E0E0E0");  // light grey
} else if (classList.contains("overcast")) {
  excelCell.fill = fill("#BFBFBF");  // darker grey
} else if (classList.contains("rainy")) {
  excelCell.fill = fill("#D0E3FF");  // soft blue
} else if (classList.contains("drizzly")) {
  excelCell.fill = fill("#B8D1F3");  // light blue-grey
} else if (classList.contains("foggy")) {
  excelCell.fill = fill("#D9D9D9");  // fog grey
} else if (classList.contains("snowy")) {
  excelCell.fill = fill("#EDF5FF");  // icy white-blue
} else if (classList.contains("stormy")) {
  excelCell.fill = fill("#f8bbd0");  // light red
} else if (classList.contains("freezing")) {
  excelCell.fill = fill("#A9CCE3");  // cold blue
} else if (classList.contains("unknown")) {
  excelCell.fill = fill("#FFFFFF");  // white
}

// GHI color mapping
else if (classList.contains("ghi-high")) {
  excelCell.fill = fill("#C6EFCE");  // green
} else if (classList.contains("ghi-medium")) {
  excelCell.fill = fill("#FFEB9C");  // yellow
} else if (classList.contains("ghi-low")) {
  excelCell.fill = fill("#FFC7CE");  // red

// Precipitation color mapping
} else if (classList.contains("precip-high")) {
  excelCell.fill = fill("#B4C6E7");  // blue
} else if (classList.contains("precip-medium")) {
  excelCell.fill = fill("#DDEBF7");  // light blue
} else if (classList.contains("precip-low")) {
  excelCell.fill = fill("#FFFFFF");  // white
}

      }
    });
  });

  worksheet.columns.forEach(col => col.width = 20);

  const blob = await workbook.xlsx.writeBuffer();
  const url = window.URL.createObjectURL(new Blob([blob]));
  const a = document.createElement("a");
  a.href = url;
  a.download = "Weather_Report.xlsx";
  a.click();

  function fill(hex) {
    return {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: hex.replace("#", "") }
    };
  }
}


  </script>
</body>
</html>
