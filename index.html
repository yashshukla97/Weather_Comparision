<!DOCTYPE html>
<html>
<head>
  <title>Weather Forecast</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .legend {
      font-size: 13px;
      font-weight: 500;
      color: #f9f5f5;
      margin-top: 10px;
    }
    .legend span {
      background: #094d81;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .table-container {
      max-height: 80vh;
      overflow-y: auto;
      margin-top: 10px;
    }

    /* Custom dropdown */

.site-selector {
  position: relative;
  display: inline-block;
  margin-right: 12px;
}
#siteButton {
  background: #006e8c;
  color: white;
  font-weight: 600;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
}
.site-list {
  position: absolute;
  top: 110%;
  left: 0;
  width: 240px;
  background-color: #303030;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 999;
  padding: 10px;
  max-height: 250px;
  overflow-y: auto;
}
.site-list label {
  display: flex;
  align-items: center;
  font-size: 14px;
  margin: 5px 0;
  color: #f9f5f5;
  cursor: pointer;
}
.site-list input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
}
.site-list.hidden {
  display: none;
}
  </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<body>
  <h2>14-Days Weather Forecast</h2>

  <!-- <div class="top-bar">
  <div>
    <label>Select Site(s):</label>
    <div class="site-selector">
      <button id="siteButton">Select Sites </button>
      <div id="siteList" class="site-list hidden">
         <label><button id="clearFilterBtn" type="button">Clear Filter</button></label>
        <label><input type="checkbox" id="selectAll"/> All Sites</label>
        <div class="options"></div>
      </div>
    </div>
    <button onclick="getBothWeathers()">Fetch Weather</button>
    <button class="download-buttons" onclick="downloadExcel()">Download Excel</button>
    <button class="download-buttons" onclick="downloadPDF()">Download PDF</button> 
  </div>
  <div class="legend">
    <span><strong>R</strong> = Radiation (kWh/m²), <strong>P</strong> = Precipitation (mm)</span>
  </div>
</div> -->

<div class="top-bar">
  <div class="left-buttons">
    <label>Select Site(s):</label>
    <div class="site-selector">
      <button id="siteButton">Select Sites </button>
      <div id="siteList" class="site-list hidden">
        <label><button id="clearFilterBtn" type="button">Clear Filter</button></label>
        <label><input type="checkbox" id="selectAll"/> All Sites</label>
        <div class="options"></div>
      </div>
    </div>
    <button onclick="getBothWeathers()">Get Weather</button>
  </div>

  <div class="download-buttons">
    <button onclick="downloadExcel()">Download Excel</button>
  </div>

  <div class="legend">
    <span><strong>R</strong> = Radiation (kWh/m²), <strong>P</strong> = Precipitation (mm)</span>
  </div>
</div>



  <div id="combinedOutput" class="table-container"></div>

  <script>
    const sites = [
      { name: "Khambhat", lat: 22.32, lon: 72.44 },
      { name: "Khilchipur", lat: 24.07, lon: 76.59 },
      { name: "Odisha", lat: 20.55, lon: 83.37 },
      { name: "Chhattisgarh", lat: 21.12, lon: 82.48 },
      { name: "Jhunir", lat: 29.81, lon: 75.37 },
      { name: "Nangla", lat: 29.86, lon: 75.20 },
      { name: "Pattikonda", lat: 15.36, lon: 77.49 },
      { name: "Hindupur", lat: 13.98, lon: 77.48 },
      { name: "Rayachotti", lat: 14.11, lon: 78.79 },
      { name: "Santipuram", lat: 12.87, lon: 78.38 },
      { name: "Yemmiganur", lat: 15.67, lon: 77.48 },
      { name: "Maddur", lat: 16.89, lon: 77.58 },
      { name: "Balanagar", lat: 16.94, lon: 78.13 },
      { name: "Banka (Nalanda)", lat: 24.81, lon: 86.86 },
      { name: "Banka (Magadh)", lat: 24.81, lon: 86.86 },
      { name: "Mahoba", lat: 25.32, lon: 79.81 },
      { name: "Sadashivpet", lat: 17.70, lon: 77.81 },
      { name: "Padmajiwadi", lat: 18.41, lon: 78.21 },
      { name: "Mothkur", lat: 17.44, lon: 79.28 },
      { name: "Godhur-2", lat: 18.80, lon: 78.63 },
      { name: "Manthani-2", lat: 18.69, lon: 79.63 },
      { name: "Kosgi", lat: 16.97, lon: 77.65 },
      { name: "Bohngir", lat: 17.72, lon: 78.98 },
      { name: "Bhadla-L2", lat: 27.46, lon: 71.97 },
      { name: "Bhadla-L3", lat: 27.48, lon: 71.99 },
      { name: "Sidlaghatta", lat: 13.48, lon: 77.90 },
      { name: "MSEDCL-2", lat: 27.50, lon: 72.47 },
      { name: "Aklera", lat: 26.47, lon: 71.54 },
      { name: "Deogarh", lat: 26.91, lon: 71.56 },
      { name: "Phalodi", lat: 26.90, lon: 71.55 },
      { name: "Raisar", lat: 26.94, lon: 71.54 },
      { name: "Dhaulpur", lat: 26.91, lon: 71.56 },
      { name: "Sikar", lat: 28.14, lon: 72.99 }
    ];

    // Build checkbox list
const siteListDiv = document.querySelector('.options');
sites.forEach(site => {
  const val = `${site.lat},${site.lon}`;
  const label = document.createElement('label');
  label.innerHTML = `<input type="checkbox" value="${val}"/> ${site.name}`;
  siteListDiv.appendChild(label);
});

// Toggle dropdown open/close
const dropdown = document.getElementById("siteList");
const button = document.getElementById("siteButton");

button.onclick = (e) => {
  e.stopPropagation();
  dropdown.classList.toggle("hidden");
};

// Close dropdown when clicking outside
document.addEventListener("click", function (e) {
  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

// Prevent dropdown from closing when clicking inside
dropdown.addEventListener("click", function (e) {
  e.stopPropagation();
});

// Select All checkbox
document.getElementById('selectAll').onclick = function () {
  const checkboxes = document.querySelectorAll('.site-list input[type="checkbox"]:not(#selectAll)');
  checkboxes.forEach(cb => cb.checked = this.checked);
};

// Clear Filter button logic
document.getElementById('clearFilterBtn').onclick = function () {
  const checkboxes = document.querySelectorAll('.site-list input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
};


    // // Build the checkbox list
    // const siteListDiv = document.querySelector('.options');
    // sites.forEach(site => {
    //   const val = `${site.lat},${site.lon}`;
    //   const label = document.createElement('label');
    //   label.innerHTML = `<input type="checkbox" value="${val}"/> ${site.name}`;
    //   siteListDiv.appendChild(label);
    // });

    // // Toggle dropdown
    // document.getElementById('siteButton').onclick = () => {
    //   document.getElementById('siteList').classList.toggle('hidden');
    // };

    // // Select all checkbox
    // document.getElementById('selectAll').onclick = function () {
    //   const checkboxes = document.querySelectorAll('.site-list input[type="checkbox"]:not(#selectAll)');
    //   checkboxes.forEach(cb => cb.checked = this.checked);
    // };

    function getSelectedSites() {
      const checked = Array.from(document.querySelectorAll('.site-list input[type="checkbox"]:checked:not(#selectAll)'));
      return checked.map(cb => {
        const [lat, lon] = cb.value.split(',');
        return sites.find(site => site.lat == lat && site.lon == lon);
      });
    }

    const weatherCodes = {
      0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
      45: "Fog", 48: "Rime fog", 51: "Light drizzle", 53: "Moderate drizzle", 55: "Dense drizzle",
      56: "Light freezing drizzle", 57: "Dense freezing drizzle", 61: "Slight rain", 63: "Moderate rain",
      65: "Heavy rain", 66: "Light freezing rain", 67: "Heavy freezing rain", 71: "Slight snow",
      73: "Moderate snow", 75: "Heavy snow", 77: "Snow grains", 80: "Slight rain showers",
      81: "Moderate rain showers", 82: "Violent rain showers", 85: "Slight snow showers",
      86: "Heavy snow showers", 95: "Thunderstorm", 96: "Thunderstorm with slight hail",
      99: "Thunderstorm with heavy hail"
    };

    function getWeatherClass(text) {
      const lower = text.toLowerCase();
      if (lower.includes("sunny") || lower.includes("clear")) return "sunny";
      if (lower.includes("cloud")) return "cloudy";
      if (lower.includes("overcast")) return "overcast";
      if (lower.includes("rain") || lower.includes("shower")) return "rainy";
      if (lower.includes("drizzle")) return "drizzly";
      if (lower.includes("fog") || lower.includes("mist") || lower.includes("haze")) return "foggy";
      if (lower.includes("snow") || lower.includes("sleet")) return "snowy";
      if (lower.includes("thunder")) return "stormy";
      if (lower.includes("freez") || lower.includes("ice")) return "freezing";
      return "unknown";
    }

    function getGHIClass(ghi) {
      if (ghi < 2) return "ghi-low";
      if (ghi < 4) return "ghi-medium";
      return "ghi-high";
    }

    function getPrecipClass(precip) {
      if (precip === 0) return "precip-low";
      if (precip < 5) return "precip-medium";
      return "precip-high";
    }

    async function getBothWeathers() {
      const selectedSites = getSelectedSites();
      document.getElementById("combinedOutput").innerHTML = "";
      let isFirst = true;
      for (let site of selectedSites) {
        await getOpenMeteoWeather(site.lat, site.lon, site.name, isFirst);
        isFirst = false;
      }
    }

    async function getOpenMeteoWeather(lat, lon, siteName, isHeaderRequired = false) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,precipitation_sum,shortwave_radiation_sum&timezone=auto&forecast_days=14`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        let row = `<tr><th class="site-column" style="text-align:center;">${siteName}</th>`;
        data.daily.time.forEach((date, i) => {
          const cond = weatherCodes[data.daily.weathercode[i]] || "Unknown";
          const ghi = +(data.daily.shortwave_radiation_sum[i] * 0.277778).toFixed(1);
          const precip = +data.daily.precipitation_sum[i].toFixed(1);
          row += `<td class="${getWeatherClass(cond)}">
            <div>${cond}</div>
            <div class="${getGHIClass(ghi)}">R - ${ghi}</div>
            <div class="${getPrecipClass(precip)}">P - ${precip}</div>
          </td>`;
        });
        row += `</tr>`;

        if (isHeaderRequired) {
          let header = `<tr><th class="site-header">Sites</th>`;
          data.daily.time.forEach(date => {
            const [yyyy, mm, dd] = date.split("-");
            header += `<th class="date-header">${dd}-${mm}</th>`;
          });
          header += `</tr>`;
          document.getElementById("combinedOutput").innerHTML += `<table><thead>${header}</thead><tbody>${row}</tbody></table>`;
        } else {
          document.querySelector("#combinedOutput table tbody").innerHTML += row;
        }
      } catch {
        document.getElementById("combinedOutput").innerHTML += `<p style="color:red;">Error fetching weather for ${siteName}</p>`;
      }
    }

  // function downloadExcel() {
  //   const table = document.querySelector("#combinedOutput table");
  //   if (!table) {
  //     alert("Please fetch weather data first.");
  //     return;
  //   }

  //   const workbook = XLSX.utils.book_new();
  //   const worksheet = XLSX.utils.table_to_sheet(table, { raw: true });

  //   // Optional: Add sheet name
  //   XLSX.utils.book_append_sheet(workbook, worksheet, "Weather Forecast");

  //   // Export the workbook
  //   XLSX.writeFile(workbook, "weather_forecast.xlsx");
  // }


  async function downloadExcel() {
    const table = document.querySelector("#combinedOutput table");
    if (!table) {
      alert("No data available to export.");
      return;
    }

    const workbook = XLSX.utils.book_new();
    const ws_data = [];
    
    // Extract table headers
    const headerCells = table.querySelectorAll("thead th");
    const headers = Array.from(headerCells).map(th => th.innerText.trim());
    ws_data.push(headers);

    // Extract table rows
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const rowData = [];
      row.querySelectorAll("td, th").forEach(cell => {
        rowData.push(cell.innerText.trim());
      });
      ws_data.push(rowData);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Apply formatting: Freeze top row and style cells (through SheetJS hacks)
    ws['!freeze'] = { xSplit: 1, ySplit: 1 }; // Freeze top row and left column
    ws['!cols'] = headers.map(() => ({ wch: 20 })); // Set column width

    XLSX.utils.book_append_sheet(workbook, ws, "Weather Report");
    XLSX.writeFile(workbook, "Weather_Forecast.xlsx");
  }

  </script>
</body>
</html>
